---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getEnvVar } from '../lib/env/cloudflare';

const mapboxToken = getEnvVar('VITE_MAPBOX_ACCESS_TOKEN') || getEnvVar('PUBLIC_MAPBOX_ACCESS_TOKEN') || import.meta.env.VITE_MAPBOX_ACCESS_TOKEN || import.meta.env.PUBLIC_MAPBOX_ACCESS_TOKEN || '';
---

<BaseLayout title="Mapbox Test">
  <main class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-4">Mapbox Test Page</h1>
    
    <div class="mb-4">
      <p>Token available: <span id="token-status">Checking...</span></p>
      <p>Token preview: <span id="token-preview">...</span></p>
    </div>
    
    <div id="map" style="width: 100%; height: 400px; border: 2px solid #ccc;"></div>
    
    <div id="error-log" class="mt-4 p-4 bg-red-100 text-red-700 rounded hidden"></div>
  </main>
</BaseLayout>

<script define:vars={{ mapboxToken }}>
  document.addEventListener('DOMContentLoaded', async () => {
    const tokenStatus = document.getElementById('token-status');
    const tokenPreview = document.getElementById('token-preview');
    const errorLog = document.getElementById('error-log');
    
    // Check token
    if (mapboxToken) {
      tokenStatus.textContent = 'Yes';
      tokenPreview.textContent = mapboxToken.substring(0, 10) + '...' + mapboxToken.substring(mapboxToken.length - 5);
    } else {
      tokenStatus.textContent = 'No';
      tokenPreview.textContent = 'Not found';
    }
    
    // Try to load Mapbox
    try {
      // Load Mapbox CSS
      const link = document.createElement('link');
      link.href = 'https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css';
      link.rel = 'stylesheet';
      document.head.appendChild(link);
      
      // Load Mapbox JS
      const script = document.createElement('script');
      script.src = 'https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js';
      document.head.appendChild(script);
      
      script.onload = () => {
        console.log('Mapbox GL JS loaded');
        
        try {
          // Set access token
          mapboxgl.accessToken = mapboxToken;
          
          // Create map
          const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-74.5, 40],
            zoom: 9
          });
          
          map.on('load', () => {
            console.log('Map loaded successfully');
            errorLog.textContent = 'Map loaded successfully!';
            errorLog.classList.remove('bg-red-100', 'text-red-700');
            errorLog.classList.add('bg-green-100', 'text-green-700');
            errorLog.classList.remove('hidden');
          });
          
          map.on('error', (e) => {
            console.error('Map error:', e);
            errorLog.textContent = 'Map error: ' + (e.error?.message || e.message || 'Unknown error');
            errorLog.classList.remove('hidden');
          });
          
        } catch (error) {
          console.error('Error creating map:', error);
          errorLog.textContent = 'Error creating map: ' + error.message;
          errorLog.classList.remove('hidden');
        }
      };
      
      script.onerror = (error) => {
        console.error('Failed to load Mapbox GL JS:', error);
        errorLog.textContent = 'Failed to load Mapbox GL JS';
        errorLog.classList.remove('hidden');
      };
      
    } catch (error) {
      console.error('Error in test page:', error);
      errorLog.textContent = 'Error: ' + error.message;
      errorLog.classList.remove('hidden');
    }
  });
</script>
</parameter>
</invoke>